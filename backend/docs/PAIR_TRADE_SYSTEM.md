# Pair Trade System Documentation\n\n## Overview\n\nThe Pair Trade System provides automated token swapping capabilities for dual-token trading strategies. It allows you to:\n\n1. **Setup Initial Positions**: Automatically convert SOL to preferred tokens when strategies start\n2. **Manual Trigger Control**: Set triggers via database updates to execute bulk swaps\n3. **Daemon Automation**: Background service that monitors triggers and executes swaps\n4. **API Management**: REST endpoints for controlling triggers and monitoring status\n\n## 🏗️ Architecture\n\n```\n┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐\n│   Database      │    │  PairTradeWorker │    │   Jupiter DEX   │\n│                 │    │                  │    │                 │\n│ pair_trade_     │◄──►│ - Initial Setup  │◄──►│ - Quote API     │\n│ triggers        │    │ - Swap Execution │    │ - Swap API      │\n│                 │    │ - Status Reports │    │                 │\n└─────────────────┘    └──────────────────┘    └─────────────────┘\n         ▲                       ▲\n         │                       │\n         ▼                       ▼\n┌─────────────────┐    ┌──────────────────┐\n│ Trigger Daemon  │    │   API Routes     │\n│                 │    │                  │\n│ - Monitor DB    │    │ - Manual Control │\n│ - Execute Swaps │    │ - Status Queries │\n│ - Reset Flags   │    │ - Configuration  │\n└─────────────────┘    └──────────────────┘\n```\n\n## 🗄️ Database Schema\n\n### `pair_trade_triggers` Table\n\n```sql\nCREATE TABLE pair_trade_triggers (\n  id SERIAL PRIMARY KEY,\n  token_a_mint VARCHAR(64) NOT NULL,\n  token_b_mint VARCHAR(64) NOT NULL,\n  token_a_symbol VARCHAR(10) NOT NULL,\n  token_b_symbol VARCHAR(10) NOT NULL,\n  \n  -- Trading configuration\n  preferred_initial_token CHAR(1) NOT NULL, -- 'A' or 'B'\n  current_direction VARCHAR(10),             -- 'A_TO_B', 'B_TO_A', 'HOLD'\n  trigger_swap BOOLEAN DEFAULT false,       -- Daemon trigger flag\n  \n  -- Tracking\n  last_triggered_at TIMESTAMP,\n  trigger_count INTEGER DEFAULT 0,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n## 🚀 Quick Start\n\n### 1. Run Migration\n\n```bash\n# Apply database migration\npsql -d your_database -f migrations/20250722_add_pair_trade_triggers.sql\n```\n\n### 2. Setup Application\n\n```typescript\nimport { setupPairTradeSystem } from './app-integration-example';\n\n// In your main app.ts\nconst daemon = await setupPairTradeSystem(app, pool);\n```\n\n### 3. Add Token Pairs\n\n```bash\n# Via API\ncurl -X POST http://localhost:3000/api/pair-trades/pair \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"tokenAMint\": \"So11111111111111111111111111111111111111112\",\n    \"tokenBMint\": \"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\",\n    \"tokenASymbol\": \"SOL\",\n    \"tokenBSymbol\": \"USDC\",\n    \"preferredInitialToken\": \"B\"\n  }'\n\n# Or via SQL\nINSERT INTO pair_trade_triggers \n(token_a_mint, token_b_mint, token_a_symbol, token_b_symbol, preferred_initial_token)\nVALUES \n('So11111111111111111111111111111111111111112', 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v', 'SOL', 'USDC', 'B');\n```\n\n## 📊 Usage Workflow\n\n### Daily Trading Workflow\n\n1. **Morning Analysis**\n   ```bash\n   # Check current positions\n   curl http://localhost:3000/api/pair-trades/strategies\n   \n   # Check trigger status\n   curl http://localhost:3000/api/pair-trades/triggers\n   ```\n\n2. **Set Trading Direction**\n   ```bash\n   # Decision: \"Market looks bullish, buy SOL with USDC\"\n   curl -X POST http://localhost:3000/api/pair-trades/trigger \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\n       \"tokenA\": \"So11111111111111111111111111111111111111112\",\n       \"tokenB\": \"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\",\n       \"direction\": \"B_TO_A\"\n     }'\n   ```\n\n3. **Monitor Execution**\n   ```bash\n   # Daemon automatically executes swaps within 5 seconds\n   # Check results\n   curl http://localhost:3000/api/pair-trades/strategies\n   ```\n\n4. **Evening Review**\n   ```bash\n   # Check performance and set overnight position\n   curl -X POST http://localhost:3000/api/pair-trades/trigger/hold \\\n     -d '{\"tokenA\": \"...\", \"tokenB\": \"...\"}'\n   ```\n\n### Alternative: Direct SQL Control\n\n```sql\n-- Set trigger to swap SOL → USDC (risk-off)\nUPDATE pair_trade_triggers \nSET current_direction = 'A_TO_B', trigger_swap = true\nWHERE token_a_symbol = 'SOL' AND token_b_symbol = 'USDC';\n\n-- Set trigger to swap USDC → SOL (risk-on)\nUPDATE pair_trade_triggers \nSET current_direction = 'B_TO_A', trigger_swap = true\nWHERE token_a_symbol = 'SOL' AND token_b_symbol = 'USDC';\n\n-- Set to HOLD (no trades)\nUPDATE pair_trade_triggers \nSET current_direction = 'HOLD', trigger_swap = false\nWHERE token_a_symbol = 'SOL' AND token_b_symbol = 'USDC';\n```\n\n## 🔧 API Reference\n\n### Trigger Management\n\n#### `POST /api/pair-trades/trigger`\nSet a manual trigger to execute swaps\n\n```json\n{\n  \"tokenA\": \"So11111111111111111111111111111111111111112\",\n  \"tokenB\": \"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\",\n  \"direction\": \"A_TO_B\"  // or \"B_TO_A\"\n}\n```\n\n#### `POST /api/pair-trades/trigger/hold`\nSet pair to HOLD (no swaps)\n\n```json\n{\n  \"tokenA\": \"So11111111111111111111111111111111111111112\",\n  \"tokenB\": \"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\"\n}\n```\n\n#### `GET /api/pair-trades/triggers`\nGet all trigger configurations\n\n#### `GET /api/pair-trades/triggers/active`\nGet only active triggers (trigger_swap = true)\n\n### Strategy Management\n\n#### `GET /api/pair-trades/strategies`\nGet all pair trade strategies and their current positions\n\n#### `POST /api/pair-trades/pair`\nAdd a new token pair configuration\n\n```json\n{\n  \"tokenAMint\": \"So11111111111111111111111111111111111111112\",\n  \"tokenBMint\": \"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\",\n  \"tokenASymbol\": \"SOL\",\n  \"tokenBSymbol\": \"USDC\",\n  \"preferredInitialToken\": \"B\"\n}\n```\n\n### Daemon Control\n\n#### `GET /api/pair-trades/daemon/status`\nGet daemon running status and configuration\n\n#### `POST /api/pair-trades/daemon/interval`\nUpdate daemon check interval\n\n```json\n{\n  \"intervalMs\": 10000\n}\n```\n\n#### `POST /api/pair-trades/trigger/manual-check`\nTrigger immediate daemon check (useful for testing)\n\n## 🎯 Key Features\n\n### 1. Initial Position Setup\n- When a new PairTradeWorker starts, it checks the database for preferred initial token\n- Automatically sells configured percentage of SOL to buy the preferred token\n- Example: 50% of SOL wallet → USDC (for stability)\n\n### 2. Bulk Trigger System\n- One database update triggers swaps across ALL strategies with that token pair\n- Perfect for market-wide decisions: \"All SOL positions should move to USDC\"\n\n### 3. Position-Aware Execution\n- Only executes swaps for strategies that need to change position\n- If strategy already holds target token, no swap occurs\n\n### 4. Automatic Reset\n- Triggers automatically reset to `false` after execution\n- Prevents duplicate executions\n- Maintains audit trail with timestamps and counts\n\n## 🔍 Monitoring & Troubleshooting\n\n### Check Daemon Status\n```bash\ncurl http://localhost:3000/api/pair-trades/daemon/status\n```\n\n### View Recent Trigger Activity\n```sql\nSELECT \n  token_a_symbol || '/' || token_b_symbol as pair,\n  current_direction,\n  trigger_swap,\n  last_triggered_at,\n  trigger_count\nFROM pair_trade_triggers \nORDER BY last_triggered_at DESC NULLS LAST;\n```\n\n### Check Strategy Positions\n```bash\ncurl http://localhost:3000/api/pair-trades/strategies\n```\n\n### Manual Daemon Trigger (Testing)\n```bash\ncurl -X POST http://localhost:3000/api/pair-trades/trigger/manual-check\n```\n\n### View Swap History\n```sql\nSELECT \n  j.id,\n  j.trading_wallet_public_key,\n  jsonb_array_length(j.data->'swapHistory') as total_swaps,\n  j.data->'swapHistory'->-1 as latest_swap\nFROM jobs j \nWHERE j.type = 'pair-trade' \nORDER BY (j.data->>'lastSwapTimestamp')::timestamp DESC NULLS LAST;\n```\n\n## ⚠️ Important Notes\n\n### Safety Features\n- All swaps use Jupiter DEX aggregator for best prices\n- Progressive slippage protection (via Jupiter integration)\n- Concurrent swap prevention per worker\n- Comprehensive error handling and logging\n\n### Production Considerations\n- Run database migrations during maintenance windows\n- Monitor daemon logs for execution status\n- Set appropriate check intervals (5s default may be too frequent for production)\n- Consider rate limiting for external API calls\n\n### Testing\n```bash\n# Run all tests\nnpm test\n\n# Run specific test suites\nnpm test PairTradeWorker\nnpm test PairTradeTriggerDaemon\nnpm test pairTradeRoutes\n```\n\n## 🔄 Integration Examples\n\n### Discord Bot Integration\n```typescript\n// Discord command: !swap SOL USDC\nclient.on('message', async (message) => {\n  if (message.content.startsWith('!swap')) {\n    const [, tokenA, tokenB] = message.content.split(' ');\n    \n    await fetch('http://localhost:3000/api/pair-trades/trigger', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        tokenA: TOKEN_MINTS[tokenA],\n        tokenB: TOKEN_MINTS[tokenB],\n        direction: 'A_TO_B'\n      })\n    });\n    \n    message.reply('Swap trigger set! All strategies will execute within 5 seconds.');\n  }\n});\n```\n\n### Webhook Integration\n```typescript\n// TradingView webhook\napp.post('/webhook/tradingview', (req, res) => {\n  const { action, pair } = req.body;\n  \n  if (action === 'BUY_SOL') {\n    // Set all USDC positions to buy SOL\n    await fetch('http://localhost:3000/api/pair-trades/trigger', {\n      method: 'POST',\n      body: JSON.stringify({\n        tokenA: 'So11111111111111111111111111111111111111112',\n        tokenB: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',\n        direction: 'B_TO_A'\n      })\n    });\n  }\n});\n```\n\nThis system provides the automated, scalable pair trading functionality you requested with complete manual control over execution timing and direction.